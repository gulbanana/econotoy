@page "/"
@implements IAsyncDisposable
@inject IJSRuntime JS
@code {
    private readonly State state = new();
    private IJSObjectReference? module;
    private ElementReference mainElement;
    private bool viewportReady;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JS.InvokeAsync<IJSObjectReference>("import", "./Pages/Index.razor.js");
            await module.InvokeVoidAsync("subscribe", mainElement, DotNetObjectReference.Create(this));
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (module != null)
        {
            await module.InvokeVoidAsync("unsubscribe");
        }        
    }

    [JSInvokable]
    public void SetDimensions(int width, int height)
    {
        state.Width = width;
        state.Height = height;
        viewportReady = true;
        StateHasChanged();
    }

    private void OnUpdate(TimeSpan elapsed)
    {
        state.Tick(elapsed);
    }
}

<nav>
    <div class="commands">
        <button @onclick="state.AddBlock">Add block</button>
    </div>

    <label>
        <input type="checkbox"> Snap to grid
    </label>
</nav>

<main @ref="mainElement">
    @if (viewportReady)
    {
        <RAF UpdateState="OnUpdate">
            <svg viewBox="0 0 @(state.Width) @(state.Height)" width="@(state.Width)px" height="@(state.Height)px">
                @foreach (var block in state.Blocks)
                {
                    <rect x="@block.X" y="@block.Y" width="@block.Width" height="@block.Height" fill="rgb(200,200,255)" />
                    <text><text x="@(block.X+44)" y="@(block.Y+56)" font-size="24">@block.Number</text></text>
                }
            </svg>
        </RAF>
    }
</main>